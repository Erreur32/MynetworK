# ===========================================
# MynetworK - Multi-Source Network Dashboard
# Docker Compose - Development Mode
# ===========================================
#
# Docker Compose configuration for DEVELOPMENT with hot reload
# Changes to source files automatically trigger recompilation and browser refresh
#
# Usage:
#   docker compose -f docker-compose.dev.yml up --build
#
# IMPORTANT: Pour éviter d'arrêter le Docker prod, utilisez un nom de projet différent :
#   docker compose -f docker-compose.dev.yml -p mynetwork-dev up --build
#
# Ou en mode détaché (background) :
#   docker compose -f docker-compose.dev.yml -p mynetwork-dev up -d --build
#
# Environment variables:
#   DASHBOARD_PORT - Vite dev server port (default: 5174)
#   SERVER_PORT    - Backend API port (default: 3003)
#   FREEBOX_HOST   - Freebox server hostname (default: mafreebox.freebox.fr)
#   JWT_SECRET     - JWT secret for authentication
#
# NOTE: Frontend port changed from 3000 to 5174 to avoid conflicts with production
#       Production uses port 7505, npm dev uses 5173, docker dev uses 5174

services:
  mynetwork-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    #container_name: Mynetwork-dev
    ports:
      - "${DASHBOARD_PORT:-3666}:5174"  # Vite dev server (frontend) - Port hôte 3666 → Port conteneur 5174
      - "${SERVER_PORT:-3668}:3003"    # API server (backend) - Port hôte 3668 → Port conteneur 3003
    environment:
      - NODE_ENV=development
      - FREEBOX_HOST=${FREEBOX_HOST:-mafreebox.freebox.fr}
      # Use local token file (shared with npm run dev)
      # In dev mode, npm uses .freebox_token-dev, but Docker will use data/freebox_token.json
      # To share the same token, we mount ./data and use the same file
      - FREEBOX_TOKEN_FILE=/app/data/freebox_token.json
      # Use local database (shared with npm run dev)
      - DATABASE_PATH=/app/data/dashboard.db
      # ⚠️ SECURITE CRITIQUE : JWT_SECRET - Secret pour signer les tokens JWT
      # 
      # IMPORTANT : Ne JAMAIS utiliser la valeur par défaut en production !
      # Le secret par défaut est uniquement pour le développement.
      #
      # Pour générer un secret sécurisé (minimum 32 caractères) :
      #   Linux/Mac:   openssl rand -base64 32
      #   PowerShell:  [Convert]::ToBase64String((1..32 | ForEach-Object { Get-Random -Maximum 256 }))
      #
      # Méthodes de configuration :
      #   1. Fichier .env (recommandé) :
      #      Créez un fichier .env avec : JWT_SECRET=votre_secret_genere
      #      Puis lancez : docker-compose -f docker-compose.dev.yml --env-file .env up --build
      #
      #   2. Variable d'environnement système :
      #      export JWT_SECRET=$(openssl rand -base64 32)
      #      docker-compose -f docker-compose.dev.yml up --build
      #
      #   3. Ligne de commande :
      #      JWT_SECRET=votre_secret docker-compose -f docker-compose.dev.yml up --build
      #
      # Exemple de secret généré : aB3xK9mP2vQ7wR5tY8uI0oP1aS6dF4gH7jK2lM9nB0vC3xZ6
      - JWT_SECRET=${JWT_SECRET:-dev_secret_change_in_production}
      - VITE_PORT=5174
      - PORT=3003
      - SERVER_PORT=${SERVER_PORT:-3668}
      - DASHBOARD_PORT=${DASHBOARD_PORT:-3666}
      # Host root path used to read real host metrics when running in Docker
      # The corresponding filesystem mount is configured in the volumes section below.
      - HOST_ROOT_PATH=${HOST_ROOT_PATH:-/host}
    volumes:
      # Mount source code for hot reload
      - .:/app
      # Preserve container's node_modules (avoid overwriting with host's)
      - /app/node_modules
      # Mount local data directory to share token and database with npm run dev
      # This allows using the same Freebox token and UniFi configs between dev modes
      - ./data:/app/data
      # Mount host filesystem (read-only) to access real host metrics
      # This allows the app to read hostname, disk usage, and other system info from the host
      - /:/host:ro
      # Mount host /proc and /sys separately for better compatibility
      # These are used to read CPU, memory, network stats, and hostname
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      # Optional: Mount external configuration file
      # Uncomment the line below to use an external config file
      # - ./config/mynetwork.conf:/app/config/mynetwork.conf:ro
      # Mount Docker socket to enable Docker version detection and stats
      - /var/run/docker.sock:/var/run/docker.sock:ro
      
    restart: unless-stopped

# Note: Using local ./data directory mount instead of Docker volume
# to share token and database with npm run dev mode
# volumes:
#   mynetwork_data_dev:
#     name: mynetwork_data_dev