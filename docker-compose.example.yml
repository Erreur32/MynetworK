# ===========================================
# MynetworK Dashboard - Docker Compose
# EXAMPLE CONFIGURATION WITH FULL DOCUMENTATION
# ===========================================
#
# This is an example configuration file with detailed documentation.
# For production use, copy this to docker-compose.yml and customize as needed.
#
# Production deployment using pre-built image from registry
# For development with hot reload, use docker-compose.dev.yml instead
#
# Usage:
#   docker-compose up -d
#
# Environment variables (optional):
#   DASHBOARD_PORT - Dashboard port (default: 7505)
#   FREEBOX_HOST - Freebox hostname (default: mafreebox.freebox.fr)
#   JWT_SECRET - JWT secret for authentication (required in production)
#
# Examples:
#   DASHBOARD_PORT=8080 docker-compose up -d
#   docker-compose --env-file .env up -d

services:
  mynetwork:
    # Docker image from GitHub Container Registry
    image: ghcr.io/erreur32/mynetwork:latest
    container_name: MynetworK
    restart: unless-stopped

    # Port mapping: host:container
    # Default: 7505 (host) -> 3000 (container)
    ports:
      - "${DASHBOARD_PORT:-7505}:3000"

    # Environment configuration
    environment:
      - NODE_ENV=production
      - PORT=3000
      
      # PUBLIC_URL: Optional - Public URL for accessing the dashboard
      # Required only if using nginx (reverse proxy)
      # Without nginx, the application works without this variable
      # Uncomment and configure if using nginx:
      # - PUBLIC_URL=${PUBLIC_URL:-http://domaine.com}
      
      # Freebox configuration
      - FREEBOX_HOST=${FREEBOX_HOST:-mafreebox.freebox.fr}
      - FREEBOX_TOKEN_FILE=/app/data/freebox_token.json
      # App name for Freebox API registration (visible in Freebox LCD/interface)
      # This name will appear in the Freebox interface when the app is registered
      # Default: "MynetworK" (can be customized to distinguish between environments)
      # Example: "MynetworK Production", "MynetworK Dev", "MynetworK Local"
      # If not set, will use the default from config.ts: "MynetworK"
      - FREEBOX_APP_NAME=${FREEBOX_APP_NAME:-MynetworK}
      - FREEBOX_DEVICE_NAME=${FREEBOX_DEVICE_NAME:-MynetworK Production}
      
      # ⚠️ SECURITE CRITIQUE : JWT_SECRET - Secret pour signer les tokens JWT
      # 
      # IMPORTANT : Ne JAMAIS utiliser la valeur par défaut en production !
      # Le secret par défaut est uniquement pour le développement.
      #
      # Pour générer un secret sécurisé (minimum 32 caractères) :
      #   Linux/Mac:   openssl rand -base64 32
      #   PowerShell:  [Convert]::ToBase64String((1..32 | ForEach-Object { Get-Random -Maximum 256 }))
      #
      # Méthodes de configuration :
      #   1. Fichier .env (recommandé) :
      #      Créez un fichier .env avec : JWT_SECRET=votre_secret_genere
      #      Puis lancez : docker-compose --env-file .env up -d
      #
      #   2. Variable d'environnement système :
      #      export JWT_SECRET=$(openssl rand -base64 32)
      #      docker-compose up -d
      #
      #   3. Ligne de commande :
      #      JWT_SECRET=votre_secret docker-compose up -d
      #
      # Exemple de secret généré : aB3xK9mP2vQ7wR5tY8uI0oP1aS6dF4gH7jK2lM9nB0vC3xZ6
      - JWT_SECRET=${JWT_SECRET:-change_me_in_production}
      
      # Optional: External config file path
      - CONFIG_FILE_PATH=${CONFIG_FILE_PATH:-/app/config/mynetwork.conf}
      
      # Host root path used to read real host metrics when running in Docker
      # The corresponding filesystem mount is configured in the volumes section below.
      - HOST_ROOT_PATH=${HOST_ROOT_PATH:-/host}

    # Persistent storage and system information mounts
    volumes:
      # Persistent storage for Freebox API token, database, and config
      # Use a named Docker volume for SQLite to avoid filesystem/permission issues
      # with network shares and ensure proper locking support.
      - mynetwork_data:/app/data
      
      # Optional: Mount external configuration file
      # Uncomment the line below to use an external config file
      # - ./config/mynetwork.conf:/app/config/mynetwork.conf:ro
      
      # ============================================
      # SYSTEM INFORMATION MOUNTS (REQUIRED)
      # ============================================
      # These mounts are required for the dashboard to display accurate system information
      # about the host machine (not the container). All mounts are read-only for security.
      
      # Mount the host root filesystem read-only inside the container
      # This allows the backend to:
      # - Read disk usage from the host filesystem
      # - Execute commands on the host (via chroot) to get disk information
      # - Access host binaries (e.g., docker, df) if needed
      # Path in container: /host
      # Security: Read-only mount (:ro) prevents any modifications to the host
      - /:/host:ro
      
      # Mount /proc from host to access host system information
      # This allows reading:
      # - Host hostname: /host/proc/sys/kernel/hostname
      # - Host uptime: /host/proc/uptime
      # - Host mount points: /host/proc/mounts (for disk detection)
      # - CPU and memory stats from the host
      # Path in container: /host/proc
      - /proc:/host/proc:ro
      
      # Mount /sys from host to access host system information
      # This allows reading additional system information and hardware details
      # Path in container: /host/sys
      - /sys:/host/sys:ro
      
      # Mount Docker socket to enable Docker statistics and version detection
      # This allows the backend to:
      # - Query Docker API for container stats (containers, images, volumes, networks)
      # - Get Docker version information
      # - Access Docker disk usage statistics
      # Path in container: /var/run/docker.sock
      # IMPORTANT: This gives the container access to Docker API. The container runs as
      # non-root user (node) for security, but still has read access to Docker socket.
      # Security: Read-only mount (:ro) prevents container from modifying Docker state
      - /var/run/docker.sock:/var/run/docker.sock:ro

    # Network mode options:
    # Option 1: Bridge mode (default) - uses port mapping
    # Option 2: Host mode - direct network access (uncomment below)
    # network_mode: host

    # Health check configuration
    # Monitors container health by checking the /api/health endpoint
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3000/api/health"]
      interval: 30s      # Check every 30 seconds
      timeout: 10s      # Timeout after 10 seconds
      retries: 3        # Retry 3 times before marking as unhealthy
      start_period: 40s # Wait 40 seconds before first check (allows startup time)

    # Resource limits (optional)
    # Uncomment to limit container resources
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '0.5'      # Maximum CPU usage
    #       memory: 512M     # Maximum memory usage
    #     reservations:
    #       cpus: '0.1'      # Reserved CPU
    #       memory: 256M     # Reserved memory

volumes:
  # Named volume for persistent data storage
  # This volume persists across container restarts and updates
  mynetwork_data:
    name: mynetwork_data

